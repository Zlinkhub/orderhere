<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Azayaka Laundry</title>
  <meta name="description" content="Cepat, bersih, dan wangi ‚Äî siap antar jemput!" />
  <link rel="icon" id="favicon" href="" />
  <style>
    :root{
      --warna-utama: #4f46e5;
      --warna-grad: #06b6d4;
      --overlay-opacity: 0.6;
    }
    *{box-sizing:border-box}
    body {
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
      padding:24px; background:linear-gradient(135deg,var(--warna-utama),var(--warna-grad));
      background-attachment: fixed;
    }
    .menu { position:fixed; left:12px; top:12px; background:rgba(255,255,255,0.9); padding:8px 10px; border-radius:10px; cursor:pointer; z-index:50; }
    .menu-list { position:fixed; left:12px; top:54px; background:#fff; border-radius:10px; padding:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:none; z-index:50; max-width:280px; }
    header { text-align:center; margin-bottom:18px; color:#fff; width:100%; max-width:760px; }
    header .brand-wrap { display:flex; gap:12px; align-items:center; justify-content:center; }
    header .logo { width:80px; height:80px; border-radius:14px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; }
    header .logo img { width:100%; height:100%; object-fit:cover; display:block; }
    header h1 { margin:0; font-size:1.4rem; font-weight:800; color:#fff; }
    header p { margin:6px 0 0; color:rgba(255,255,255,0.9); font-style:italic; }
    .form-wrap { width:100%; max-width:760px; background:rgba(255,255,255,0.95); border-radius:14px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.12); }
    label{display:block;margin-top:10px;font-weight:600;color:#111}
    input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:6px;font-size:14px}
    textarea{min-height:64px;resize:vertical}
    .pin-btn{background:#10b981;color:#fff;border:none;border-radius:8px;padding:10px;cursor:pointer;margin-top:8px}
    .submit-btn{background:linear-gradient(90deg,var(--warna-utama),var(--warna-grad));color:#fff;border:none;padding:12px;border-radius:10px;font-weight:700;margin-top:12px;cursor:pointer}
    .small{font-size:13px;color:#666;margin-top:6px}
    .row{display:flex;gap:10px}
    .price-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
    @media(max-width:820px){ body{padding:12px} header{padding:0 6px} .form-wrap{padding:14px} .row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="menu" onclick="toggleMenu()">‚ò∞</div>
  <div class="menu-list" id="menuList"></div>

  <header>
    <div class="brand-wrap">
      <div class="logo" id="logoWrap"><img id="logoImg" src="" alt="logo" style="display:none"></div>
    </div>
    <h1 id="shopName">Azayaka Laundry</h1>
    <p id="shopBio">Cepat, bersih, dan wangi ‚Äî siap antar jemput!</p>
  </header>

  <div class="form-wrap" id="formWrap">
    <form id="orderForm">
      <label>Nama</label>
      <input id="nama" required />

      <label>No. WhatsApp</label>
      <input id="wa" placeholder="08xxxxxxxxxx" required />

      <label>Jenis Laundry</label>
      <select id="jenis" required>
        <option value="">Pilih Jenis</option>
        <option value="Kiloan">Kiloan</option>
        <option value="Satuan">Satuan</option>
      </select>

      <div id="kiloanBlock" style="display:none">
        <label>Pilihan Kiloan</label>
        <select id="kiloanPick">
          <option value="Setrika Saja">Setrika Saja</option>
          <option value="Cuci Kering Lipat">Cuci Kering Lipat</option>
          <option value="Cuci + Setrika">Cuci + Setrika</option>
        </select>
      </div>

      <div id="satuanBlock" style="display:none">
        <label>Item Satuan</label>
        <div id="satuanList"></div>
        <div class="small">Pilih item dan isi jumlah (qty)</div>
      </div>

      <label>Estimasi</label>
      <select id="estimasi" required>
        <option value="Reguler (2-3 hari)">Reguler (2-3 hari)</option>
        <option value="Express (1 hari)">Express (1 hari)</option>
      </select>

      <label>Delivery</label>
      <select id="delivery" required>
        <option value="Pick Up">Pick Up</option>
        <option value="Drop Off">Drop Off</option>
      </select>

      <label>Waktu (jam)</label>
      <input id="waktu" type="time" required />

      <label>Alamat (opsional jika sudah pin lokasi)</label>
      <textarea id="alamat"></textarea>

      <button type="button" class="pin-btn" id="pinBtn">üìç Pin Lokasi Saya</button>
      <div class="small" id="lokasiInfo">Belum ada lokasi</div>

      <label>Catatan Tambahan (opsional)</label>
      <textarea id="catatan" placeholder="Contoh: jangan campur warna, parfum: floral"></textarea>

      <button type="submit" class="submit-btn">Kirim Pesanan</button>
    </form>
  </div>

<script>
/* ---------- Utilities ---------- */
const b64Encode = s => btoa(unescape(encodeURIComponent(s)));
const b64Decode = s => decodeURIComponent(escape(atob(s)));
let CONFIG = {};

/* ---------- Load config and apply ---------- */
async function loadConfig(){
  try{
    const res = await fetch('config.json');
    CONFIG = await res.json();
  }catch(e){
    CONFIG = {};
    console.warn('Tidak dapat load config.json', e);
  }
  applyConfig();
}
function applyConfig(){
  document.title = CONFIG.nama_toko || 'Laundry';
  document.querySelector("meta[name='description']").content = CONFIG.bio || '';
  const favicon = document.getElementById('favicon');
  if(CONFIG.logo){ favicon.href = CONFIG.logo; document.getElementById('logoImg').src = CONFIG.logo; document.getElementById('logoImg').style.display='block'; }
  document.getElementById('shopName').innerText = CONFIG.nama_toko || 'Azayaka Laundry';
  document.getElementById('shopBio').innerText = CONFIG.bio || '';
  document.documentElement.style.setProperty('--warna-utama', CONFIG.warna_utama || '#4f46e5');
  document.documentElement.style.setProperty('--warna-grad', CONFIG.warna_gradasi || '#06b6d4');
  document.documentElement.style.setProperty('--overlay-opacity', (CONFIG.opacity_overlay!=null)?CONFIG.opacity_overlay:0.6);
  // background image fallback: if bg_foto present, set body background image combined with gradient
  if(CONFIG.bg_foto){
    document.body.style.background = `linear-gradient(135deg, rgba(79,70,229,0.6), rgba(6,182,212,0.6)), url('${CONFIG.bg_foto}')`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  }
  renderMenu();
  renderPriceItems();
}
function renderMenu(){
  const menu = document.getElementById('menuList'); menu.innerHTML='';
  const info = CONFIG.menu_info || {};
  for(const k in info){
    const a = document.createElement('a'); a.href = info[k]; a.target='_blank'; a.innerText = k;
    menu.appendChild(a);
  }
}

/* ---------- Price items (satuan) ---------- */
function renderPriceItems(){
  const list = document.getElementById('satuanList'); list.innerHTML='';
  const arr = CONFIG.harga_satuan || [];
  arr.forEach((it, idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginTop='6px';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.name = it.nama; chk.dataset.price = it.harga;
    const lbl = document.createElement('div'); lbl.innerText = `${it.nama} ‚Äî Rp ${Number(it.harga).toLocaleString()}`; lbl.style.flex='1';
    const qty = document.createElement('input'); qty.type='number'; qty.min=0; qty.value=0; qty.style.width='90px'; qty.disabled=true;
    chk.addEventListener('change', ()=>{ qty.disabled = !chk.checked; if(!chk.checked) qty.value=0; });
    row.appendChild(chk); row.appendChild(lbl); row.appendChild(qty);
    list.appendChild(row);
  });
}

/* ---------- Menu toggle ---------- */
function toggleMenu(){ const m = document.getElementById('menuList'); m.style.display = m.style.display==='block' ? 'none' : 'block'; }

/* ---------- Show layanan based on jenis ---------- */
document.getElementById('jenis').addEventListener('change', (e)=>{
  const v = e.target.value;
  document.getElementById('kiloanBlock').style.display = (v==='Kiloan') ? 'block' : 'none';
  document.getElementById('satuanBlock').style.display = (v==='Satuan') ? 'block' : 'none';
});

/* ---------- LocalStorage nama & WA ---------- */
document.getElementById('nama').value = localStorage.getItem('laundry_nama') || '';
document.getElementById('wa').value = localStorage.getItem('laundry_wa') || '';

/* ---------- Geolocation pin ---------- */
let lokasiLink = '';
document.getElementById('pinBtn').addEventListener('click', ()=>{
  const info = document.getElementById('lokasiInfo'); info.innerText = 'Mengambil lokasi...';
  if(!navigator.geolocation){ info.innerText = 'Browser tidak mendukung geolokasi'; return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    lokasiLink = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
    localStorage.setItem('laundry_lokasi', lokasiLink);
    info.innerText = '‚úÖ Lokasi berhasil diambil';
    document.getElementById('alamat').required = false;
  }, err=>{ info.innerText = '‚ùå Gagal mengambil lokasi'; });
});

/* ---------- Submit: build message, open WA, save to GitHub order file ---------- */
document.getElementById('orderForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const nama = document.getElementById('nama').value.trim();
  const wa = document.getElementById('wa').value.trim();
  const jenis = document.getElementById('jenis').value;
  const layanan = (jenis==='Kiloan') ? document.getElementById('kiloanPick').value : (()=>{ const sel = document.getElementById('satuanList'); const arr=[]; sel.querySelectorAll('div').forEach(div=>{ const chk = div.querySelector('input[type=checkbox]'); const qty = div.querySelector('input[type=number]'); if(chk && chk.checked && Number(qty.value)>0) arr.push({nama:chk.dataset.name, harga:Number(chk.dataset.price), qty: Number(qty.value)}); }); return arr.length? JSON.stringify(arr):'-'; })();
  const estimasi = document.getElementById('estimasi').value;
  const delivery = document.getElementById('delivery').value;
  const waktu = document.getElementById('waktu').value;
  const alamat = document.getElementById('alamat').value.trim() || '-';
  const catatan = document.getElementById('catatan').value.trim() || '-';
  const lokasi = lokasiLink || localStorage.getItem('laundry_lokasi') || '-';

  if(!alamat && lokasi==='-') { alert('Mohon isi alamat atau pin lokasi'); return; }

  // Save nama & wa locally
  localStorage.setItem('laundry_nama', nama);
  localStorage.setItem('laundry_wa', wa);

  // Message
  const now = new Date();
  const hari = now.toLocaleDateString('id-ID',{weekday:'long'});
  const tanggal = now.toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
  const jam = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
  let pesan = `üß∫ *PESAN LAUNDRY* üß∫%0A*${CONFIG.nama_toko || 'Laundry'}*%0A%0A`;
  pesan += `üìÖ _${hari}, ${tanggal} pukul ${jam}_%0A%0A`;
  pesan += `üë§ Nama: ${nama}%0Aüì± No. WA: ${wa}%0Aüß• Jenis: ${jenis}%0Aüßº Layanan: ${layanan}%0A`;
  pesan += `‚è≥ Estimasi: ${estimasi}%0Aüöö Delivery: ${delivery}%0Aüïì Waktu: ${waktu}%0A`;
  pesan += `üè† Alamat: ${alamat}%0Aüìç Lokasi: ${lokasi}%0A%0A`;
  pesan += `_Terima kasih sudah memesan di ${CONFIG.nama_toko || 'Laundry'}_`;

  // open WA to admin if admin_wa set
  if(CONFIG.admin_wa) window.open(`https://wa.me/${CONFIG.admin_wa}?text=${pesan}`, '_blank');

  // Prepare order data and save to GitHub
  const order = {
    waktu_iso: now.toISOString(),
    waktu_display: `${hari}, ${tanggal} pukul ${jam}`,
    nama, wa, jenis, layanan, estimasi, delivery, waktu, alamat, lokasi, catatan
  };

  try{
    const repo = CONFIG.github_repo || 'Zlinkhub/orderhere';
    const pat = CONFIG.pat || ''; // PAT is optional; if empty attempt unauthenticated (likely fails for write)
    const dateFile = now.toISOString().split('T')[0];
    const url = `https://api.github.com/repos/${repo}/contents/order/${dateFile}.json`;

    // get existing
    let sha = null; let existing = null;
    const check = await fetch(url, { headers: pat? { Authorization: `token ${pat}` } : {} });
    if(check.ok){
      const j = await check.json(); sha = j.sha; existing = JSON.parse(b64Decode(j.content));
    }
    const arr = Array.isArray(existing) ? existing : [];
    arr.push(order);

    const body = { message: `Tambah pesanan baru (${nama})`, content: b64Encode(JSON.stringify(arr, null, 2)) };
    if(sha) body.sha = sha;

    const put = await fetch(url, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(pat?{ Authorization:`token ${pat}` }:{} ) }, body: JSON.stringify(body) });
    if(!put.ok){ const err = await put.json(); console.warn('Gagal simpan order:', err); alert('Pesanan terkirim, tapi gagal menyimpan ke repo (cek PAT/Repo).'); }
    else alert('‚úÖ Pesanan terkirim dan (semoga) tersimpan. Terima kasih!');
    document.getElementById('orderForm').reset();
    lokasiLink = ''; document.getElementById('lokasiInfo').innerText = 'Belum ada lokasi';
  }catch(err){
    console.error(err); alert('Kesalahan saat menyimpan pesanan (cek console).');
  }
});

/* ---------- Init ---------- */
(async ()=>{ await loadConfig(); })();
</script>
</body>
</html>