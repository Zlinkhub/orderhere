<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Order Laundry ‚Äî Azayaka Laundry</title>
<link rel="icon" id="favicon" href=""/>
<style>
  :root{--c1:#4CAF50;--c2:#81C784}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; margin:0; min-height:100vh; background:var(--bg,linear-gradient(135deg,var(--c1),var(--c2))); color:#111;}
  .menu{position:fixed;left:12px;top:12px;background:#fff;padding:8px 10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:80;cursor:pointer}
  .menu-content{position:fixed;left:12px;top:56px;background:#fff;border-radius:10px;padding:10px;box-shadow:0 8px 30px rgba(0,0,0,.12);display:none;z-index:80;min-width:220px}
  header{max-width:900px;margin:40px auto 8px;text-align:center;color:#fff}
  .logo{width:140px;height:140px;border-radius:20px;overflow:hidden;margin:0 auto;background:#fff;display:flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:12px 0 6px;cursor:pointer}
  p.bio{margin:0;opacity:.95}
  .card{max-width:760px;margin:18px auto;background:#fff;padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.08)}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:6px;font-size:15px}
  .row{display:flex;gap:10px}
  .btn{background:linear-gradient(90deg,var(--c1),var(--c2));color:#fff;border:0;padding:12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn-secondary{background:#f3f4f6;color:#111;border:0}
  .two{display:flex;gap:10px}
  footer{max-width:760px;margin:20px auto;text-align:center;color:#fff;opacity:.95}
  @media(max-width:820px){ .row{flex-direction:column} .logo{width:100px;height:100px} }
</style>
</head>
<body>
  <div class="menu" id="menuBtn">‚ò∞</div>
  <div class="menu-content" id="menuContent"></div>

  <header>
    <div class="logo" id="logoWrap"><img id="logoImg" src="" alt="logo" style="display:none"></div>
    <h1 id="storeName">Laundry</h1>
    <p class="bio" id="storeBio">Cepat, bersih, wangi ‚Äî siap antar jemput</p>
  </header>

  <div class="card">
    <form id="orderForm">
      <label>Nama</label>
      <input id="custName" required/>

      <label>No. WhatsApp</label>
      <input id="custPhone" placeholder="contoh: 0852xxxxxxx" required/>

      <label>Jenis</label>
      <select id="jenis" required>
        <option value="">Pilih</option><option value="Kiloan">Kiloan</option><option value="Satuan">Satuan</option>
      </select>

      <div id="jenisDetail"></div>

      <label>Estimasi</label>
      <select id="estimasi">
        <option>Reguler (2-3 hari)</option>
        <option>Express (1 hari)</option>
        <option>Express Sameday (6 jam)</option>
      </select>

      <label>Delivery</label>
      <select id="delivery">
        <option>Drop Off</option><option>Pickup</option>
      </select>

      <label>Waktu (keinginan)</label>
      <input id="waktu" type="time"/>

      <label>Alamat (opsional jika sudah pin lokasi)</label>
      <textarea id="alamat" placeholder="Contoh: Jl. Mawar No.1"></textarea>

      <div class="two" style="margin-top:12px">
        <button type="button" class="btn-secondary" id="pinBtn">üìç Pin Lokasi</button>
        <button type="button" class="btn" id="sendAdminBtn">Kirim ke Admin</button>
      </div>
    </form>
  </div>

  <footer>
    <span id="footerText"></span>
  </footer>

<script>
/* ---------- Globals ---------- */
let CONFIG = {};
let lokasiLink = "";
const ownerRepo = "Zlinkhub/orderhere";

/* ---------- Load config ---------- */
async function loadConfig(){
  try{
    const r = await fetch('config.json'); CONFIG = await r.json();
  }catch(e){ CONFIG = {}; console.warn('config.json load failed',e); }
  applyConfig();
}
function applyConfig(){
  document.getElementById('storeName').innerText = CONFIG.storeName || 'Laundry';
  document.getElementById('storeBio').innerText = CONFIG.bio || '';
  document.getElementById('footerText').innerText = `${CONFIG.storeName || 'Laundry'} ‚Ä¢ ${new Date().getFullYear()}`;
  if(CONFIG.logo){ const img = document.getElementById('logoImg'); img.src = CONFIG.logo; img.style.display='block'; }
  // theme
  document.documentElement.style.setProperty('--c1', CONFIG.theme?.color1 || '#4CAF50');
  document.documentElement.style.setProperty('--c2', CONFIG.theme?.color2 || '#81C784');
  // menu links
  renderMenu();
}
function renderMenu(){
  const menu = document.getElementById('menuContent'); menu.innerHTML='';
  const links = CONFIG.links || {};
  if(links.pricelist) menu.innerHTML += `<a href="${links.pricelist}" target="_blank">Daftar Harga</a>`;
  if(links.social) menu.innerHTML += `<a href="${links.social}" target="_blank">Sosial Media</a>`;
  menu.innerHTML += `<a href="#" onclick="showAdminLogin()">Login Admin</a>`;
}

/* ---------- Menu toggle ---------- */
document.getElementById('menuBtn').addEventListener('click', ()=> {
  const el = document.getElementById('menuContent'); el.style.display = (el.style.display==='block')?'none':'block';
});

/* ---------- jenis detail ---------- */
document.getElementById('jenis').addEventListener('change', (e)=>{
  const v = e.target.value; const d = document.getElementById('jenisDetail');
  if(v==='Kiloan'){
    d.innerHTML = `<label>Opsi Kiloan</label>
      <select id="layanan">
        <option>Cuci + Setrika</option>
        <option>Cuci Kering Lipat</option>
        <option>Setrika Saja</option>
      </select>`;
  } else if(v==='Satuan'){
    const satuan = (CONFIG.pricing?.satuan || []).map(x=>`<option data-price="${x.harga}">${x.nama} - Rp ${Number(x.harga).toLocaleString()}</option>`).join('');
    d.innerHTML = `<label>Item Satuan</label><select id="layanan">${satuan}</select>`;
  } else d.innerHTML='';
});

/* ---------- local save ---------- */
document.getElementById('custName').value = localStorage.getItem('custName') || '';
document.getElementById('custPhone').value = localStorage.getItem('custPhone') || '';

/* ---------- geolocation ---------- */
document.getElementById('pinBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Perangkat tidak mendukung lokasi.');
  navigator.geolocation.getCurrentPosition(p=>{
    lokasiLink = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
    alert('Lokasi berhasil diambil');
    document.getElementById('alamat').required = false;
  }, err=> alert('Gagal mengambil lokasi: '+err.message));
});

/* ---------- triple tap admin login on title ---------- */
let taps=0; const title = document.getElementById('storeName');
title.addEventListener('click', ()=>{
  taps++; setTimeout(()=>taps=0,800); if(taps>=3) showAdminLogin();
});

/* ---------- admin login modal (simple prompt) ---------- */
function showAdminLogin(){
  const u = prompt('Username admin:'); const p = prompt('Password:');
  if(u==='Zlink' && p==='1234'){ window.open('admin.html','_blank'); } else alert('Login gagal');
}

/* ---------- Save order to GitHub (daily file) ---------- */
async function saveOrderToGitHub(order){
  // requires admin PAT entry (will be prompted once and stored in sessionStorage)
  let pat = sessionStorage.getItem('gh_pat');
  if(!pat) pat = prompt('Masukkan GitHub PAT (diperlukan untuk menyimpan pesanan):') || '';
  if(!pat) return alert('Tidak ada PAT, pesanan tidak disimpan di repo.');

  // build path
  const date = new Date().toISOString().split('T')[0];
  const path = `order/${date}.json`;
  const apiUrl = `https://api.github.com/repos/${ownerRepo}/contents/${path}`;

  // check existing
  let existingResp = await fetch(apiUrl);
  let sha = null; let arr = [];
  if(existingResp.ok){
    const js = await existingResp.json();
    sha = js.sha;
    try{ arr = JSON.parse(atob(js.content)); }catch(e){ arr = []; }
  }

  // add id & timestamps & status
  order.id = `ord-${Date.now()}`;
  order.created_at = new Date().toISOString();
  order.status = "Order Masuk";
  order.payment = { status: "Belum Bayar", method: "", proof: "" };

  arr.push(order);
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2))));
  const body = { message: `Tambah order ${order.id}`, content };
  if(sha) body.sha = sha;

  const put = await fetch(apiUrl, {
    method:'PUT',
    headers:{ Authorization:`token ${pat}`, 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if(!put.ok){ const err = await put.json(); console.error('saveOrder failed',err); alert('Pesanan terkirim tapi gagal tersimpan ke repo. Periksa PAT & izin repo.'); return; }
  sessionStorage.setItem('gh_pat', pat);
  alert('Pesanan berhasil dikirim dan disimpan.');
}

/* ---------- send to admin button ---------- */
document.getElementById('sendAdminBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('custName').value.trim();
  const phone = document.getElementById('custPhone').value.trim();
  if(!name||!phone) return alert('Nama dan WA wajib');
  const jenis = document.getElementById('jenis').value;
  const layanan = document.getElementById('layanan')?.value || '-';
  const estimasi = document.getElementById('estimasi').value;
  const delivery = document.getElsementById('delivery').value;
  const waktu = document.getElementById('waktu').value || '-';
  const alamat = document.getElementById('alamat').value || '-';
  const order = { name, phone, jenis, layanan, estimasi, delivery, waktu, alamat, lokasi: lokasiLink || '-' };

  // save locally for next use
  localStorage.setItem('custName', name); localStorage.setItem('custPhone', phone);

  // 1) save order to GitHub
  await saveOrderToGitHub(order);

  // 2) send WA to admin
  const adminNo = CONFIG.adminPhone || CONFIG.adminPhone || '';
  if(adminNo){
    const now = new Date(); const dateStr = now.toLocaleString('id-ID', { weekday:'long', day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
    let text = `üß∫ *PESAN LAUNDRY* üß∫%0A*${CONFIG.storeName || 'Laundry'}*%0A%0AüìÖ _${dateStr}_%0A%0Aüë§ Nama: ${name}%0Aüì± No. WA: ${phone}%0Aüß• Jenis: ${jenis}%0Aüßº Layanan: ${layanan}%0A‚è≥ Estimasi: ${estimasi}%0Aüöö Delivery: ${delivery}%0Aüïì Waktu: ${waktu}%0Aüè† Alamat: ${alamat}%0Aüìç Lokasi: ${order.lokasi}%0A%0A_Terima kasih!_`;
    window.open(`https://wa.me/${adminNo}?text=${text}`,'_blank');
  } else alert('Pesanan dikirim, tapi nomor admin belum diatur di config.json');
});

/* ---------- init ---------- */
loadConfig();
</script>
</body>
</html>